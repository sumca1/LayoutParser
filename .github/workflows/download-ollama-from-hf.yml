name: Download Ollama Model from HuggingFace

on:
  workflow_dispatch:
    inputs:
      model_url:
        description: 'HuggingFace model URL (https://huggingface.co/...)'
        required: true
        default: 'https://huggingface.co/bartowski/Meta-Llama-3.1-8B-Instruct-GGUF/resolve/main/Meta-Llama-3.1-8B-Instruct-Q4_K_M.gguf'
      model_name:
        description: '×©× ×”××•×“×œ (llama3.1:8b)'
        required: true
        default: 'llama3.1:8b'
      chunk_size_mb:
        description: '×’×•×“×œ chunk ×‘××’×”-×‘×ª×™×'
        required: false
        default: '95'

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          
      - name: Download from HuggingFace
        run: |
          MODEL_URL="${{ github.event.inputs.model_url }}"
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          MODEL_FOLDER="${MODEL_NAME//:/_}"
          
          mkdir -p "$MODEL_FOLDER"
          
          echo "ğŸ“¥ ××•×¨×™×“ ×-HuggingFace..."
          echo "ğŸ”— URL: $MODEL_URL"
          
          # ×”×•×¨×“×” ×¢× wget (×ª×•××š resume)
          cd "$MODEL_FOLDER"
          wget -c --progress=bar:force "$MODEL_URL" -O model.gguf || {
            echo "âŒ ×”×•×¨×“×” × ×›×©×œ×”"
            exit 1
          }
          
          SIZE_MB=$(du -m model.gguf | cut -f1)
          SIZE_GB=$(echo "scale=2; $SIZE_MB / 1024" | bc)
          
          echo "âœ… ×”×•×¨×“×” ×”×•×©×œ××”!"
          echo "ğŸ“Š ×’×•×“×œ: ${SIZE_MB}MB (${SIZE_GB}GB)"
          
          if [ $SIZE_MB -lt 50 ]; then
            echo "âš ï¸  ××–×”×¨×”: ×”×§×•×‘×¥ ×§×˜×Ÿ ××“×™ - ××•×œ×™ ×”×”×•×¨×“×” × ×›×©×œ×”?"
            exit 1
          fi
          
      - name: Create Modelfile
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          MODEL_FOLDER="${MODEL_NAME//:/_}"
          
          cd "$MODEL_FOLDER"
          
          echo "ğŸ“ ×™×•×¦×¨ Modelfile..."
          echo "FROM ./model.gguf" > Modelfile
          
          echo "âœ… Modelfile × ×•×¦×¨"
          
      - name: Split if needed
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          MODEL_FOLDER="${MODEL_NAME//:/_}"
          CHUNK_SIZE="${{ github.event.inputs.chunk_size_mb }}"
          
          cd "$MODEL_FOLDER"
          
          # ×’×•×“×œ ×‘bytes
          SIZE_BYTES=$(stat -c%s model.gguf)
          SIZE_MB=$((SIZE_BYTES / 1048576))
          
          echo "ğŸ“Š ×’×•×“×œ: ${SIZE_MB}MB | ×¡×£: ${CHUNK_SIZE}MB"
          
          if [ $SIZE_MB -gt $CHUNK_SIZE ]; then
            echo "âœ‚ï¸  ××¤×¦×œ ×œchunks ×©×œ ${CHUNK_SIZE}MB..."
            split -b ${CHUNK_SIZE}m model.gguf "part_"
            rm model.gguf
            
            echo "âœ… × ×•×¦×¨×• ××§×˜×¢×™×:"
            ls -lh part_* | head -20
            NUM_PARTS=$(ls -1 part_* | wc -l)
            echo "ğŸ“¦ ×¡×”\"×›: $NUM_PARTS ××§×˜×¢×™×"
            
            # ×¡×§×¨×™×¤×˜ reassemble bash
            echo '#!/bin/bash' > reassemble.sh
            echo 'cat part_* > model.gguf' >> reassemble.sh
            echo 'echo "âœ… ××•×—×“ ×œ-model.gguf"' >> reassemble.sh
            echo 'rm part_*' >> reassemble.sh
            chmod +x reassemble.sh
            
            # ×¡×§×¨×™×¤×˜ reassemble PowerShell
            echo '$parts = Get-ChildItem -Filter "part_*" | Sort-Object Name' > reassemble.ps1
            echo '$output = "model.gguf"' >> reassemble.ps1
            echo '$outStream = [System.IO.File]::OpenWrite($output)' >> reassemble.ps1
            echo 'foreach ($part in $parts) {' >> reassemble.ps1
            echo '    Write-Host "ğŸ“ $($part.Name)"' >> reassemble.ps1
            echo '    $bytes = [System.IO.File]::ReadAllBytes($part.FullName)' >> reassemble.ps1
            echo '    $outStream.Write($bytes, 0, $bytes.Length)' >> reassemble.ps1
            echo '}' >> reassemble.ps1
            echo '$outStream.Close()' >> reassemble.ps1
            echo 'Write-Host "âœ… ××•×—×“ ×œ-$output"' >> reassemble.ps1
            echo 'Remove-Item part_* -Force' >> reassemble.ps1
            
            echo "âœ… × ×•×¦×¨×• ×¡×§×¨×™×¤×˜×™ reassemble"
          else
            echo "âš¡ ×§×•×‘×¥ ×§×˜×Ÿ ×-${CHUNK_SIZE}MB - ×œ× ×¦×¨×™×š ×¤×™×¦×•×œ"
          fi
          
      - name: Upload as GitHub Release
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          MODEL_FOLDER="${MODEL_NAME//:/_}"
          RELEASE_TAG="${MODEL_FOLDER}_$(date +%Y%m%d_%H%M%S)"
          
          cd "$MODEL_FOLDER"
          
          # ×™×¦×™×¨×ª tarball
          echo "ğŸ“¦ ×™×•×¦×¨ ××¨×›×™×•×Ÿ..."
          tar -czf "../${MODEL_FOLDER}.tar.gz" .
          cd ..
          
          SIZE_MB=$(du -m "${MODEL_FOLDER}.tar.gz" | cut -f1)
          echo "ğŸ“Š ×’×•×“×œ ××¨×›×™×•×Ÿ: ${SIZE_MB}MB"
          
          # ×‘×“×™×§×” ×× ×¦×¨×™×š ×œ×¤×¦×œ ××ª ×”××¨×›×™×•×Ÿ (>1500MB = 1.5GB, ×›×“×™ ×œ×”×©××™×¨ ××¨×•×•×— ×‘×˜×™×—×•×ª)
          if [ $SIZE_MB -gt 1500 ]; then
            echo "âœ‚ï¸  ××¨×›×™×•×Ÿ ×’×“×•×œ ($SIZE_MB MB) - ××¤×¦×œ ×œ-releases ××¨×•×‘×™×..."
            
            # ×¤×™×¦×•×œ ×œ×§×‘×¦×™× ×©×œ 1.5GB (1500MB)
            split -b 1500m "${MODEL_FOLDER}.tar.gz" "${MODEL_FOLDER}_part_"
            
            NUM_PARTS=$(ls -1 ${MODEL_FOLDER}_part_* | wc -l)
            echo "ğŸ“¦ × ×•×¦×¨×• $NUM_PARTS ××§×˜×¢×™×"
            
            # ×™×¦×™×¨×ª ×¡×§×¨×™×¤×˜ ××™×—×•×“
            echo '#!/bin/bash' > reassemble_archive.sh
            echo "cat ${MODEL_FOLDER}_part_* > ${MODEL_FOLDER}.tar.gz" >> reassemble_archive.sh
            echo "tar -xzf ${MODEL_FOLDER}.tar.gz" >> reassemble_archive.sh
            echo "cd ${MODEL_FOLDER}" >> reassemble_archive.sh
            echo "if [ -f reassemble.sh ]; then ./reassemble.sh; fi" >> reassemble_archive.sh
            chmod +x reassemble_archive.sh
            
            # ×™×¦×™×¨×ª release ×¢× ×›×œ ×”××§×˜×¢×™×
            echo "ğŸ·ï¸  ×™×•×¦×¨ release: $RELEASE_TAG"
            gh release create "$RELEASE_TAG" \
              --title "Ollama Model: $MODEL_NAME (Multi-part)" \
              --notes "ğŸ“¦ Ollama model downloaded from HuggingFace (×¤×•×¦×œ ×œ-$NUM_PARTS ××§×˜×¢×™×)
          
          **Model:** $MODEL_NAME
          **Total Size:** ${SIZE_MB}MB
          **Parts:** $NUM_PARTS files
          
          **×œ×”×ª×§× ×”:**
          \`\`\`bash
          # ×”×•×¨×“ ××ª ×›×œ ×”××§×˜×¢×™×
          wget https://github.com/${{ github.repository }}/releases/download/$RELEASE_TAG/${MODEL_FOLDER}_part_*
          wget https://github.com/${{ github.repository }}/releases/download/$RELEASE_TAG/reassemble_archive.sh
          
          # ××—×“ ×•×”×ª×§×Ÿ
          chmod +x reassemble_archive.sh
          ./reassemble_archive.sh
          ollama create $MODEL_NAME -f ${MODEL_FOLDER}/Modelfile
          \`\`\`" \
              ${MODEL_FOLDER}_part_* reassemble_archive.sh
            
            rm -f ${MODEL_FOLDER}.tar.gz
          else
            echo "ğŸ“¤ ××¨×›×™×•×Ÿ ×§×˜×Ÿ ($SIZE_MB MB) - ××¢×œ×” ×›×§×•×‘×¥ ×™×—×™×“..."
            
            # ×™×¦×™×¨×ª release
            echo "ğŸ·ï¸  ×™×•×¦×¨ release: $RELEASE_TAG"
            
            gh release create "$RELEASE_TAG" \
              --title "Ollama Model: $MODEL_NAME" \
              --notes "ğŸ“¦ Ollama model downloaded from HuggingFace
          
          **Model:** $MODEL_NAME
          **Size:** ${SIZE_MB}MB
          
          **×œ×”×ª×§× ×”:**
          \`\`\`bash
          # ×”×•×¨×“ ××ª ×”××¨×›×™×•×Ÿ
          wget https://github.com/${{ github.repository }}/releases/download/$RELEASE_TAG/${MODEL_FOLDER}.tar.gz
          
          # ×—×œ×¥
          tar -xzf ${MODEL_FOLDER}.tar.gz
          cd ${MODEL_FOLDER}
          
          # ××—×“ ××§×˜×¢×™× (×× ×™×©)
          if [ -f reassemble.sh ]; then
            ./reassemble.sh
          fi
          
          # ×”×ª×§×Ÿ ×‘-Ollama
          ollama create $MODEL_NAME -f Modelfile
          \`\`\`" \
              "${MODEL_FOLDER}.tar.gz"
          fi
          
          echo "âœ… ×”××•×“×œ ×”×•×¢×œ×” ×›-release!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Summary
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          MODEL_FOLDER="${MODEL_NAME//:/_}"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ ×”×•×¨×“×” ×”×•×©×œ××”!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ ××•×“×œ: $MODEL_NAME"
          echo "ğŸ·ï¸  Release: https://github.com/${{ github.repository }}/releases"
          echo ""
          echo "×œ×”×ª×§× ×”:"
          echo "1. ×œ×š ×œ-Releases ×‘GitHub"
          echo "2. ×”×•×¨×“ ××ª ×”×§×•×‘×¥ .tar.gz"
          echo "3. tar -xzf <file>.tar.gz"
          echo "4. cd $MODEL_FOLDER"
          echo "5. ×× ×™×© part_* - ×”×¨×¥ reassemble.sh"
          echo "6. ollama create $MODEL_NAME -f Modelfile"
          echo ""
          echo "×œ×©×™××•×©:"
          echo "ollama run $MODEL_NAME"
          echo ""
