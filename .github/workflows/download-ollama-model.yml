name: Download Ollama Model

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: '×©× ××•×“×œ Ollama (×œ××©×œ: llama3.1:8b)'
        required: true
        default: 'llama3.1:8b'
      chunk_size_mb:
        description: '×’×•×“×œ chunk ×‘××’×”-×‘×ª×™×'
        required: false
        default: '95'

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 ×©×¢×•×ª ××§×¡×™××•×
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          
      - name: Install Ollama
        run: |
          echo "ğŸ“¥ ××ª×§×™×Ÿ Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
          echo "âœ… Ollama ××•×ª×§×Ÿ"
          
      - name: Start Ollama service
        run: |
          echo "ğŸš€ ××¤×¢×™×œ Ollama service ×‘×¨×§×¢..."
          nohup ollama serve > ollama.log 2>&1 &
          sleep 10
          
          echo "ğŸ” ×‘×•×“×§ ×©×”×©×™×¨×•×ª ×¨×¥..."
          if pgrep -x "ollama" > /dev/null; then
            echo "âœ… Ollama service ×¨×¥"
          else
            echo "âŒ Ollama service ×œ× ×¨×¥"
            cat ollama.log
            exit 1
          fi
          
      - name: Download model with Ollama
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          
          echo "ğŸ“¥ ××•×¨×™×“ $MODEL_NAME..."
          echo "â³ ×–×” ×¢×©×•×™ ×œ×§×—×ª 10-15 ×“×§×•×ª ×œ××•×“×œ ×’×“×•×œ..."
          
          # ×”×•×¨×“×” ×¢× timeout ×©×œ 30 ×“×§×•×ª
          timeout 1800 ollama pull "$MODEL_NAME" || {
            echo "âŒ ×”×”×•×¨×“×” × ×›×©×œ×” ××• timeout"
            exit 1
          }
          
          echo "âœ… ×”×•×¨×“×” ×”×•×©×œ××”!"
          echo ""
          echo "ğŸ“Š ×¨×©×™××ª ××•×“×œ×™×:"
          ollama list
          
      - name: Export model
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          MODEL_FOLDER="${MODEL_NAME//:/_}"
          
          echo "ğŸ“¦ ××™×™×¦× ××ª ×”××•×“×œ..."
          mkdir -p "$MODEL_FOLDER"
          
          # ××¨×›×™×•×Ÿ ×©×œ ×ª×™×§×™×™×ª .ollama (×©× × ××¦× ×”××•×“×œ)
          echo "ğŸ—œï¸  ×™×•×¦×¨ ××¨×›×™×•×Ÿ ×-~/.ollama/..."
          cd ~
          tar -czf "$GITHUB_WORKSPACE/$MODEL_FOLDER/models.tar.gz" .ollama/ || {
            echo "âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ××¨×›×™×•×Ÿ"
            exit 1
          }
          
          cd "$GITHUB_WORKSPACE/$MODEL_FOLDER"
          SIZE_MB=$(du -m models.tar.gz | cut -f1)
          SIZE_GB=$(echo "scale=2; $SIZE_MB / 1024" | bc)
          
          echo "âœ… × ×•×¦×¨ ××¨×›×™×•×Ÿ: models.tar.gz"
          echo "ğŸ“Š ×’×•×“×œ: ${SIZE_MB}MB (${SIZE_GB}GB)"
          
          if [ $SIZE_MB -lt 100 ]; then
            echo "âš ï¸  ××–×”×¨×”: ×”×§×•×‘×¥ ×§×˜×Ÿ ××“×™ - ××•×œ×™ ×”×”×•×¨×“×” × ×›×©×œ×”?"
            exit 1
          fi
          

          
      - name: Split if needed
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          MODEL_FOLDER="${MODEL_NAME//:/_}"
          CHUNK_SIZE="${{ github.event.inputs.chunk_size_mb }}"
          
          cd "$MODEL_FOLDER"
          
          # ×’×•×“×œ ×‘bytes
          SIZE_BYTES=$(stat -f%z models.tar.gz 2>/dev/null || stat -c%s models.tar.gz)
          SIZE_MB=$((SIZE_BYTES / 1048576))
          
          echo "ğŸ“Š ×’×•×“×œ: ${SIZE_MB}MB | ×¡×£: ${CHUNK_SIZE}MB"
          
          # GitHub ××’×‘×™×œ 100MB ×œ×§×•×‘×¥ - ××– ×ª××™×“ × ×¤×¦×œ ×× ×’×“×•×œ ××”×¡×£
          if [ $SIZE_MB -gt $CHUNK_SIZE ]; then
            echo "âœ‚ï¸  ××¤×¦×œ ×œchunks ×©×œ ${CHUNK_SIZE}MB..."
            split -b ${CHUNK_SIZE}m models.tar.gz "part_"
            rm models.tar.gz
            
            echo "âœ… × ×•×¦×¨×• ××§×˜×¢×™×:"
            ls -lh part_* | head -20
            NUM_PARTS=$(ls -1 part_* | wc -l)
            echo "ğŸ“¦ ×¡×”\"×›: $NUM_PARTS ××§×˜×¢×™×"
            
            # ×™×¦×™×¨×ª ×¡×§×¨×™×¤×˜ reassemble bash
            echo '#!/bin/bash' > reassemble.sh
            echo 'cat part_* > models.tar.gz' >> reassemble.sh
            echo 'echo "âœ… ××•×—×“ ×œ-models.tar.gz"' >> reassemble.sh
            echo 'rm part_*' >> reassemble.sh
            chmod +x reassemble.sh
            
            # ×™×¦×™×¨×ª ×¡×§×¨×™×¤×˜ reassemble PowerShell
            echo '# PowerShell reassemble script' > reassemble.ps1
            echo '$parts = Get-ChildItem -Filter "part_*" | Sort-Object Name' >> reassemble.ps1
            echo '$output = "models.tar.gz"' >> reassemble.ps1
            echo '$outStream = [System.IO.File]::OpenWrite($output)' >> reassemble.ps1
            echo 'foreach ($part in $parts) {' >> reassemble.ps1
            echo '    Write-Host "ğŸ“ $($part.Name)"' >> reassemble.ps1
            echo '    $bytes = [System.IO.File]::ReadAllBytes($part.FullName)' >> reassemble.ps1
            echo '    $outStream.Write($bytes, 0, $bytes.Length)' >> reassemble.ps1
            echo '}' >> reassemble.ps1
            echo '$outStream.Close()' >> reassemble.ps1
            echo 'Write-Host "âœ… ××•×—×“ ×œ-$output"' >> reassemble.ps1
            echo 'Remove-Item part_* -Force' >> reassemble.ps1
            
            echo "âœ… × ×•×¦×¨×• ×¡×§×¨×™×¤×˜×™ reassemble"
          else
            echo "âš¡ ×§×•×‘×¥ ×§×˜×Ÿ ×-${CHUNK_SIZE}MB - ×œ× ×¦×¨×™×š ×¤×™×¦×•×œ"
          fi
          
      - name: Commit and push
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          MODEL_FOLDER="${MODEL_NAME//:/_}"
          
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add "$MODEL_FOLDER"
          git commit -m "ğŸ¤– Add Ollama model: $MODEL_NAME" || echo "No changes to commit"
          git push origin main || git push origin HEAD:main
          
          echo "âœ… ×”××•×“×œ ×”×•×¢×œ×” ×œ-GitHub!"
          
      - name: Summary
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          MODEL_FOLDER="${MODEL_NAME//:/_}"
          
          cd "$MODEL_FOLDER"
          
          if ls part_* 1> /dev/null 2>&1; then
            echo "ğŸ“¦ ×”××•×“×œ ×¤×•×¦×œ ×œ××§×˜×¢×™×:"
            ls -lh part_*
            echo ""
            echo "×œ×”×•×¨×“×” ×•×”×ª×§× ×”:"
            echo "1. git clone --depth 1 --filter=blob:none --sparse ${{ github.repository }}"
            echo "2. cd $(basename ${{ github.repository }})"
            echo "3. git sparse-checkout set $MODEL_FOLDER"
            echo "4. cd $MODEL_FOLDER && ./reassemble.sh"
            echo "5. tar -xzf models.tar.gz -C ~/.ollama/"
          else
            SIZE=$(du -h models.tar.gz | cut -f1)
            echo "ğŸ“¦ ×”××•×“×œ ××•×›×Ÿ ×œ×”×•×¨×“×”: models.tar.gz ($SIZE)"
            echo ""
            echo "×œ×”×•×¨×“×” ×•×”×ª×§× ×”:"
            echo "1. git clone --depth 1 --filter=blob:none --sparse ${{ github.repository }}"
            echo "2. cd $(basename ${{ github.repository }})"
            echo "3. git sparse-checkout set $MODEL_FOLDER"
            echo "4. cd $MODEL_FOLDER"
            echo "5. tar -xzf models.tar.gz -C ~/.ollama/"
          fi
          
          echo ""
          echo "×œ×©×™××•×©:"
          echo "ollama run $MODEL_NAME"
