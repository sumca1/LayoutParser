name: Download DictaBERT from HuggingFace

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model name for release tag'
        required: true
        default: 'dictabert-large-char-menaked'
      hf_repo:
        description: 'HuggingFace repository'
        required: true
        default: 'dicta-il/dictabert-large-char-menaked'

jobs:
  download_and_release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install huggingface-hub
        run: |
          pip install huggingface-hub
      
      - name: Download DictaBERT from HuggingFace
        run: |
          echo "ğŸ“¥ Downloading ${{ inputs.hf_repo }}..."
          
          # ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×–×× ×™×ª
          mkdir -p dictabert_download
          
          # ×”×•×¨×“×” ×¢× huggingface-cli
          python -c "
          from huggingface_hub import snapshot_download
          import os
          
          model_path = snapshot_download(
              repo_id='${{ inputs.hf_repo }}',
              local_dir='dictabert_download',
              local_dir_use_symlinks=False
          )
          print(f'âœ… Downloaded to: {model_path}')
          
          # ×”×“×¤×¡ ×¨×©×™××ª ×§×‘×¦×™×
          for root, dirs, files in os.walk('dictabert_download'):
              for file in files:
                  filepath = os.path.join(root, file)
                  size = os.path.getsize(filepath) / (1024**2)
                  print(f'{filepath}: {size:.2f} MB')
          "
      
      - name: Create archive
        run: |
          echo "ğŸ“¦ Creating archive..."
          cd dictabert_download
          
          # ××¨×›×™×•×Ÿ tar.gz
          tar -czf ../dictabert-model.tar.gz .
          cd ..
          
          # ×’×•×“×œ ×”×§×•×‘×¥
          size=$(stat -f%z dictabert-model.tar.gz 2>/dev/null || stat -c%s dictabert-model.tar.gz)
          size_mb=$((size / 1024 / 1024))
          echo "Archive size: ${size_mb} MB"
          
          # ×× ×™×•×ª×¨ ×-1500MB, ×¤×™×¦×•×œ
          if [ $size_mb -gt 1500 ]; then
            echo "ğŸ“¦ Splitting archive (size: ${size_mb}MB)..."
            split -b 1500M dictabert-model.tar.gz dictabert-model.tar.gz.part_
            rm dictabert-model.tar.gz
            ls -lh dictabert-model.tar.gz.part_*
          fi
      
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ×©× ×™×™×—×•×“×™ ×œrelease
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          TAG_NAME="${{ inputs.model_name }}_${TIMESTAMP}"
          
          echo "ğŸ·ï¸ Creating release: $TAG_NAME"
          
          # ×™×¦×™×¨×ª release
          gh release create "$TAG_NAME" \
            --title "DictaBERT Model - ${{ inputs.model_name }}" \
            --notes "**DictaBERT Hebrew Nikud Model**
          
          Model: \`${{ inputs.hf_repo }}\`
          Downloaded: $(date)
          Size: ~1.2GB
          
          **×”×ª×§× ×”:**
          1. ×”×•×¨×“ ××ª ×›×œ ×”×§×‘×¦×™×
          2. ×—×œ×¥: \`tar -xzf dictabert-model.tar.gz\` (××• ××—×“ ××ª ×”×—×œ×§×™× ×§×•×“×)
          3. ×”×©×ª××© ×‘-\`test_dictabert_offline.py\`
          
          **Files:**" \
            dictabert-model.tar.gz* || echo "âš ï¸ Release creation may have failed"
          
          echo "âœ… Release created successfully!"
